# core/domain/metadata/hitl_policies.yaml
# SPEC-53: HITL (Human-in-the-Loop) 确认策略配置
#
# 定义哪些操作需要用户确认，以及确认策略
#
# 确认级别：
# - NONE: 不需要确认
# - LOW: 低风险，可选确认
# - MEDIUM: 中风险，需要确认
# - HIGH: 高风险，必须确认
# - CRITICAL: 关键操作，必须确认+原因

# 高风险操作 - 需要确认+原因
high_risk_actions:
  - action_type: adjust_bill
    level: CRITICAL
    require_reason: true
    reason_prompt: "请输入账单调整原因"
    allowed_roles: ["manager"]
    description: "账单调整影响收入，需要经理权限和原因"

  - action_type: delete_guest
    level: CRITICAL
    require_reason: true
    reason_prompt: "请输入删除客人原因"
    allowed_roles: ["manager", "sysadmin"]
    description: "删除客人记录是敏感操作"

  - action_type: cancel_reservation
    level: HIGH
    require_reason: true
    reason_prompt: "请输入取消预订原因"
    allowed_roles: ["manager", "receptionist"]
    description: "取消预订可能影响收入"

  - action_type: delete_payment
    level: HIGH
    require_reason: true
    reason_prompt: "请输入删除支付记录原因"
    allowed_roles: ["manager"]
    description: "删除支付记录影响财务"

# 中风险操作 - 需要确认
medium_risk_actions:
  - action_type: extend_stay
    level: MEDIUM
    require_confirmation: true
    allowed_roles: ["manager", "receptionist"]
    description: "续住可能影响后续预订"

  - action_type: change_room
    level: MEDIUM
    require_confirmation: true
    allowed_roles: ["manager", "receptionist"]
    description: "换房涉及房间状态变更"

  - action_type: walkin_checkin
    level: MEDIUM
    require_confirmation: true
    allowed_roles: ["manager", "receptionist"]
    description: "散客入住需要房间分配"

  - action_type: checkout
    level: MEDIUM
    require_confirmation: true
    allowed_roles: ["manager", "receptionist", "cleaner"]
    description: "退房操作触发账单结算"

# 低风险操作 - 可选确认或无需确认
low_risk_actions:
  - action_type: create_task
    level: LOW
    require_confirmation: false
    allowed_roles: ["manager", "receptionist", "cleaner"]
    description: "创建清洁或维护任务"

  - action_type: assign_task
    level: LOW
    require_confirmation: false
    allowed_roles: ["manager", "housekeeper"]
    description: "分配任务给员工"

  - action_type: start_task
    level: NONE
    require_confirmation: false
    allowed_roles: ["cleaner", "housekeeper"]
    description: "开始任务无需确认"

  - action_type: complete_task
    level: LOW
    require_confirmation: false
    allowed_roles: ["cleaner", "housekeeper"]
    description: "完成任务更新房间状态"

  - action_type: add_payment
    level: MEDIUM
    require_confirmation: true
    allowed_roles: ["manager", "receptionist"]
    description: "收款操作需要确认金额"

  - action_type: update_room_status
    level: MEDIUM
    require_confirmation: true
    allowed_roles: ["manager", "housekeeper"]
    description: "手动修改房态需要确认"

  - action_type: create_reservation
    level: LOW
    require_confirmation: false
    allowed_roles: ["manager", "receptionist"]
    description: "创建预订是常规操作"

  - action_type: checkin
    level: MEDIUM
    require_confirmation: true
    allowed_roles: ["manager", "receptionist"]
    description: "办理入住涉及房间分配"

# 查询类操作 - 无需确认
query_actions:
  - action_type: view
    level: NONE
    require_confirmation: false

  - action_type: query_rooms
    level: NONE
    require_confirmation: false

  - action_type: query_reservations
    level: NONE
    require_confirmation: false

  - action_type: query_guests
    level: NONE
    require_confirmation: false

  - action_type: query_tasks
    level: NONE
    require_confirmation: false

  - action_type: query_reports
    level: NONE
    require_confirmation: false

# 角色豁免 - 某些角色的用户可以跳过确认
role_exemptions:
  manager:
    skip_confirmation:
      - add_payment
      - create_reservation
      - update_room_status
    description: "经理对日常操作有经验，可以跳过部分确认"

  sysadmin:
    skip_confirmation:
      - update_room_status
      - create_task
      - assign_task
    description: "系统管理员可以管理系统配置"

# 阈值策略 - 基于参数值动态调整确认级别
threshold_policies:
  payment_threshold:
    action_type: add_payment
    threshold: 1000.0
    below_level: MEDIUM
    at_or_above_level: HIGH
    description: "单笔支付超过1000元需要更高确认"

  adjustment_threshold:
    action_type: adjust_bill
    threshold: 500.0
    below_level: CRITICAL
    at_or_above_level: CRITICAL
    always_require_reason: true
    description: "账单调整超过500元始终需要原因"

  quantity_threshold:
    action_type: create_task
    threshold: 10
    below_level: LOW
    at_or_above_level: MEDIUM
    description: "批量创建超过10个任务需要中级确认"

# 时间窗口策略 - 特定时间段内的操作需要额外确认
time_window_policies:
  after_hours:
    start: "22:00"
    end: "06:00"
    elevated_actions:
      - action_type: checkout
        from_level: MEDIUM
        to_level: HIGH
      - action_type: extend_stay
        from_level: MEDIUM
        to_level: HIGH
    description: "夜间操作提高确认级别"

  weekend:
    days: [5, 6]  # 周五、周六
    elevated_actions:
      - action_type: adjust_bill
        from_level: CRITICAL
        to_level: CRITICAL
        require_manager_approval: true
    description: "周末账单调整需要经理批准"
