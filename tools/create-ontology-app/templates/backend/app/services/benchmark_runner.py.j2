"""
Benchmark execution engine.
"""
import json
import logging
import os
from datetime import date, datetime, timedelta
from typing import Dict, List, Optional

from sqlalchemy.orm import Session

from app.models.benchmark import (
    BenchmarkCase, BenchmarkCaseResult, BenchmarkRun, BenchmarkSuite,
)
from app.{{ domain_name }}.models.ontology import Employee
from app.services.benchmark_assertions import (
    evaluate_l2_action,
    evaluate_l3_db,
    evaluate_l4_response,
    evaluate_query_result,
    evaluate_exec_result,
    evaluate_all,
)

logger = logging.getLogger(__name__)

QUERY_ACTIONS = {"ontology_query", "query_smart", "view", "semantic_query", "query_reports"}


def _is_query_action(action_type: str) -> bool:
    return action_type in QUERY_ACTIONS or action_type.startswith("query_")


def _resolve_placeholders(input_text: str) -> str:
    today = date.today()
    replacements = {
        "$today": today.isoformat(),
        "$tomorrow": (today + timedelta(days=1)).isoformat(),
        "$day_after_tomorrow": (today + timedelta(days=2)).isoformat(),
        "$yesterday": (today - timedelta(days=1)).isoformat(),
    }
    result = input_text
    for placeholder, value in replacements.items():
        result = result.replace(placeholder, value)
    return result


BENCHMARK_INIT_DIR = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))), "benchmark_init")


def list_init_scripts() -> List[str]:
    scripts = []
    if os.path.isdir(BENCHMARK_INIT_DIR):
        for f in sorted(os.listdir(BENCHMARK_INIT_DIR)):
            if f.endswith(".py") and f != "__init__.py":
                scripts.append(f)
    return scripts


def run_single_suite(suite: BenchmarkSuite, db: Session, user: Employee) -> BenchmarkRun:
    """Execute all cases in a single suite."""
    # TODO: Import your domain's AI service for benchmark execution
    logger.warning("Benchmark runner: no domain AI service configured yet")

    existing_run = db.query(BenchmarkRun).filter_by(suite_id=suite.id).first()
    if existing_run:
        db.query(BenchmarkCaseResult).filter_by(run_id=existing_run.id).delete()
        db.delete(existing_run)
        db.commit()

    run = BenchmarkRun(
        suite_id=suite.id,
        status="error",
        total_cases=len(suite.cases),
        passed=0,
        failed=0,
        error_count=len(suite.cases),
        started_at=datetime.utcnow(),
        finished_at=datetime.utcnow(),
    )
    db.add(run)
    db.commit()
    db.refresh(run)
    return run


def run_suites(suite_ids: List[int], db: Session, user: Employee) -> List[BenchmarkRun]:
    runs = []
    for suite_id in suite_ids:
        suite = db.query(BenchmarkSuite).filter_by(id=suite_id).first()
        if not suite:
            logger.warning(f"Suite {suite_id} not found, skipping")
            continue
        run = run_single_suite(suite, db, user)
        runs.append(run)
    return runs
